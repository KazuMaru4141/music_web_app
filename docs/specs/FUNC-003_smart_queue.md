# FUNC-003: スマートキュー自動生成 (Smart Queue)

## 1. 機能概要 (Overview)
**機能ID:** FUNC-003
**名称:** スマート・コンテキスト・キューイング（Smart Queue）
**目的:** 「次になにを聴こう？」というユーザーの迷いを解消するため、既知のお気に入り曲と未開拓の曲を最適なバランス（黄金比）でミックスし、ワンクリックでSpotifyの再生キューに追加する。

## 2. 事前条件 (Pre-conditions)
* ユーザーが Spotify Premium アカウントでログインしていること（キュー操作権限が必要）。
* DBにある程度の楽曲データおよび関連アーティストデータが蓄積されていること。

## 3. 入力・操作 (Inputs / Triggers)
* **UIトリガー:** `NowPlaying` 画面の「✨ Smart Mix」ボタンをクリック。
* **入力パラメータ:** なし（セッション情報からユーザーコンテキストを取得）。

## 4. 処理ロジック (Processing Logic)
以下のロジックで計5曲を選出し、リストを作成する。

1.  **New Release 枠 (2曲):**
    * **ロジック:** システム日付から「現在の西暦（例: 2026）」を取得。
    * **クエリ:** `release_date` が現在の西暦で始まり、かつ `is_featured=true` または `rate` が未評価（NULL/0）の曲をDBからランダムに取得。
    * **目的:** 最新トレンドの消化とキャッチアップ。

2.  **Anchor 枠 (1曲):**
    * **ロジック:** `rate >= 4` または `is_featured=true` の曲をランダムに取得（ただし、今年の新譜は除く）。
    * **目的:** ユーザーが確実に好きな曲を混ぜることで、リスニングの満足度と継続率を維持する。

3.  **Deep Dive 枠 (2曲):**
    * **ロジック:** `related_artists` テーブルからランダムにアーティストを選出。
    * **Spotify連携:** 選ばれたアーティストの `Top Tracks` を Spotify API で取得。
    * **フィルタ:** 定番すぎる曲（Top 1）を避け、あえて 2〜3番目の人気曲を選出する（Serendipityの演出）。
    * **目的:** データベース外の新規楽曲との出会い。

4.  **キュー追加実行:**
    * 選出された5曲の URI リストを作成。
    * `spotifyApi.addToQueue(uri)` を順次実行し、実機のSpotifyアプリの「次に再生」リストに追加する。

## 5. 出力・結果 (Outputs / Post-conditions)
* **UI変化:**
    * 「✨ Added 5 tracks to Queue!」というトースト通知を表示。
    * ボタンのローディング状態が解除される。
* **外部システム変化:**
    * ユーザーのSpotifyアプリ（スマホ/PC）の再生キューに5曲が追加される。

## 6. 例外処理 (Error Handling / Edge Cases)
* **DBデータ不足:**
    * 新譜や評価済み曲がDBにない場合、該当枠をスキップし、取得できた曲のみをキューに追加する。0曲の場合は「No tracks found」を返す。
* **Spotify再生権限エラー:**
    * ユーザーが無料プランの場合など、キュー操作が許可されていない場合は 403 エラーを返し、UI側で「Premiumアカウントが必要です」と警告する。
* **Deep Dive 失敗:**
    * 関連アーティストのTop Tracksが取得できない（APIエラーや曲がない）場合、その枠は無視して処理を続行する（All or Nothing にしない）。